version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies"
      - pip install aws-sam-cli awscli --upgrade

  pre_build:
    commands:
      - echo "Checking stack status..."
      - |
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name hello-world-api --region eu-north-1 --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
        if [ "$STACK_STATUS" = "DELETE_FAILED" ]; then
          echo "Stack is in DELETE_FAILED state, removing with retained resources..."
          aws cloudformation delete-stack --stack-name hello-world-api --region eu-north-1 --retain-resources "HelloWorldFunction" "ServerlessRestApi"
          echo "Waiting for stack deletion..."
          sleep 30
        fi
      - echo "Verifying template files..."
      - ls -la
      - echo "Template content:"
      - cat template.yaml

  build:
    commands:
      - echo "Building application with SAM"
      - sam build --debug

  post_build:
    commands:
      - echo "Packaging application"
      - sam package \
          --s3-bucket hello-lambda-deployments-binodbandara \
          --output-template-file packaged.yaml \
          --region eu-north-1
      
      - echo "Deploying application"
      - sam deploy \
          --template-file packaged.yaml \
          --stack-name hello-world-api \
          --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
          --region eu-north-1 \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset \
          --force-upload \
          --debug

artifacts:
  files:
    - packaged.yaml
    - template.yaml
  discard-paths: yes
